<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Live Trader</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #09090b;
            --card: #18181b;
            --border: #27272a;
            --text: #fafafa;
            --muted: #71717a;
            --green: #22c55e;
            --red: #ef4444;
            --blue: #3b82f6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--muted);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        .status-dot.offline { background: var(--red); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .stat-value.positive { color: var(--green); }
        .stat-value.negative { color: var(--red); }

        .stat-sub {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 0.25rem;
        }

        /* Scheduler Card - Special */
        .scheduler-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .countdown {
            font-size: 2rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--blue);
        }

        .session-info {
            text-align: right;
        }

        .session-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .session-time {
            font-size: 0.75rem;
            color: var(--muted);
        }

        /* Section */
        .section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
        }

        /* Table */
        .table-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            text-align: left;
            padding: 0.875rem 1rem;
            font-weight: 500;
            color: var(--muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }

        td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(255,255,255,0.02); }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.win { background: rgba(34, 197, 94, 0.15); color: var(--green); }
        .badge.loss { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .badge.open { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
        .badge.bullish { background: rgba(34, 197, 94, 0.15); color: var(--green); }
        .badge.bearish { background: rgba(239, 68, 68, 0.15); color: var(--red); }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--muted);
        }

        /* Collapsible */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            cursor: pointer;
            user-select: none;
        }

        .collapsible-header:hover {
            background: rgba(255,255,255,0.02);
        }

        .collapsible-title {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .collapsible-toggle {
            color: var(--muted);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .collapsible-content {
            display: none;
            border-top: 1px solid var(--border);
        }

        .collapsible-content.open {
            display: block;
        }

        /* Percentile Table */
        .pct-table th, .pct-table td {
            text-align: center;
            padding: 0.625rem 0.5rem;
        }

        .pct-table th:first-child, .pct-table td:first-child {
            text-align: left;
            padding-left: 1rem;
        }

        .pct-pair {
            font-weight: 600;
        }

        .pct-session {
            font-size: 0.7rem;
            color: var(--muted);
            margin-left: 0.5rem;
        }

        .pct-value {
            font-variant-numeric: tabular-nums;
        }

        .pct-value.tp { color: var(--green); }
        .pct-value.sl { color: var(--red); }

        /* Filter tabs */
        .filter-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg);
            padding: 0.25rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--muted);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s;
        }

        .filter-tab:hover {
            color: var(--text);
        }

        .filter-tab.active {
            background: var(--card);
            color: var(--text);
        }

        /* Connect button */
        .connect-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .connect-btn:hover {
            background: var(--border);
        }

        .connect-btn.connected {
            border-color: var(--green);
        }

        .connect-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--muted);
        }

        .connect-dot.active {
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
        }

        /* Price ticker grid */
        .price-ticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1px;
            background: var(--border);
        }

        .price-ticker-item {
            background: var(--card);
            padding: 0.875rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .price-ticker-pair {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .price-ticker-mid {
            font-size: 1.125rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .price-ticker-spread {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--muted);
        }

        .price-ticker-bid { color: var(--green); }
        .price-ticker-ask { color: var(--red); }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .stats-grid > :last-child {
                grid-column: span 2;
            }
        }

        @media (max-width: 640px) {
            body { padding: 1rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .stats-grid > :last-child { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Forex Live Trader</h1>
        <div class="status">
            <div class="status-dot" id="wsDot" title="Polygon WebSocket"></div>
            <span id="wsText">WS</span>
            <div class="status-dot" id="statusDot" style="margin-left: 1rem;"></div>
            <span id="statusText">Connecting...</span>
        </div>
    </header>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Balance</div>
            <div class="stat-value" id="balance">$10,000.00</div>
            <div class="stat-sub">Initial: <span id="initialBalance">$10,000.00</span></div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Profit / Loss</div>
            <div class="stat-value" id="pnl">$0.00</div>
            <div class="stat-sub" id="pnlPct">0.00%</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="winRate">0%</div>
            <div class="stat-sub"><span id="wins">0</span>W / <span id="losses">0</span>L</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Drawdown</div>
            <div class="stat-value negative" id="drawdown">0.00%</div>
            <div class="stat-sub">Peak: <span id="peakBalance">$10,000.00</span></div>
        </div>

        <div class="stat-card scheduler-card">
            <div>
                <div class="stat-label">Next Session</div>
                <div class="countdown" id="countdown">--:--:--</div>
            </div>
            <div class="session-info">
                <div class="session-name" id="nextSession">-</div>
                <div class="session-time" id="sessionTime">-</div>
            </div>
        </div>
    </div>

    <!-- Real-Time Price Ticker -->
    <div class="section">
        <div class="section-header">
            <h2 class="section-title">Real-Time Prices</h2>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span class="stat-sub" id="priceUpdateTime">-</span>
                <button class="connect-btn" id="priceConnectBtn" onclick="togglePriceStream()">
                    <span class="connect-dot" id="priceConnectDot"></span>
                    <span id="priceConnectText">Connect</span>
                </button>
            </div>
        </div>
        <div class="table-card" id="priceTickerCard">
            <div id="priceTickerContent" class="empty-state">Click Connect to stream real-time prices</div>
        </div>
    </div>

    <!-- Recent Trades -->
    <div class="section">
        <div class="section-header">
            <h2 class="section-title">Recent Trades</h2>
        </div>
        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Pair</th>
                        <th>Session</th>
                        <th>Direction</th>
                        <th>Entry</th>
                        <th>TP / SL</th>
                        <th>Lots</th>
                        <th>Outcome</th>
                        <th>P/L</th>
                    </tr>
                </thead>
                <tbody id="tradesBody">
                    <tr><td colspan="9" class="empty-state">No trades yet</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Percentile Targets (Collapsible) -->
    <div class="section">
        <div class="table-card">
            <div class="collapsible-header" onclick="togglePercentiles()">
                <span class="collapsible-title">Percentile Targets</span>
                <div class="collapsible-toggle">
                    <div class="filter-tabs" onclick="event.stopPropagation()">
                        <button class="filter-tab active" data-session="all">All</button>
                        <button class="filter-tab" data-session="Asian_Open">Asian</button>
                        <button class="filter-tab" data-session="London_Open">London</button>
                        <button class="filter-tab" data-session="NY_Open">NY</button>
                    </div>
                    <span id="toggleText">Show</span>
                </div>
            </div>
            <div class="collapsible-content" id="percentileContent">
                <table class="pct-table">
                    <thead>
                        <tr>
                            <th>Pair</th>
                            <th>TP (P75)</th>
                            <th>SL (P50)</th>
                            <th>Accuracy</th>
                            <th>Samples</th>
                        </tr>
                    </thead>
                    <tbody id="percentileBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let account = {};
        let scheduler = {};
        let trades = [];
        let percentiles = [];
        let selectedSession = 'all';
        let percentilesOpen = false;
        let priceStreamConnected = false;
        let pricePollingInterval = null;

        const fmt = {
            usd: (v) => '$' + Number(v || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
            pct: (v) => Number(v || 0).toFixed(2) + '%',
            price: (v, pair) => {
                const decimals = (pair && (pair.includes('JPY') || pair.includes('XAG'))) ? 3 : 5;
                return Number(v || 0).toFixed(decimals);
            },
            time: (iso) => {
                if (!iso) return '-';
                const d = new Date(iso);
                return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            }
        };

        function updateCountdown() {
            if (!scheduler.next_session_time) return;
            const target = new Date(scheduler.next_session_time);
            const now = new Date();
            const diff = target - now;

            if (diff <= 0) {
                document.getElementById('countdown').textContent = 'NOW';
                return;
            }

            const hours = Math.floor(diff / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            document.getElementById('countdown').textContent =
                `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateAccountUI() {
            const pnl = account.pnl || 0;
            document.getElementById('balance').textContent = fmt.usd(account.balance);
            document.getElementById('initialBalance').textContent = fmt.usd(account.initial_balance);

            const pnlEl = document.getElementById('pnl');
            pnlEl.textContent = (pnl >= 0 ? '+' : '') + fmt.usd(pnl);
            pnlEl.className = 'stat-value ' + (pnl >= 0 ? 'positive' : 'negative');

            document.getElementById('pnlPct').textContent = (account.pnl_pct >= 0 ? '+' : '') + fmt.pct(account.pnl_pct);
            document.getElementById('winRate').textContent = fmt.pct(account.win_rate);
            document.getElementById('wins').textContent = account.winning_trades || 0;
            document.getElementById('losses').textContent = account.losing_trades || 0;
            document.getElementById('drawdown').textContent = fmt.pct(account.max_drawdown_pct);
            document.getElementById('peakBalance').textContent = fmt.usd(account.peak_balance);
        }

        function updateSchedulerUI() {
            document.getElementById('nextSession').textContent = scheduler.next_session?.replace('_', ' ') || '-';
            document.getElementById('sessionTime').textContent = scheduler.next_session_time
                ? new Date(scheduler.next_session_time).toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                : '-';

            // Update WebSocket status indicator (for scheduler's trading WebSocket)
            const wsConnected = scheduler.websocket_connected || false;
            const wsDot = document.getElementById('wsDot');
            wsDot.className = 'status-dot' + (wsConnected ? '' : ' offline');
            wsDot.title = wsConnected ? 'Trading WebSocket: Connected' : 'Trading WebSocket: Disconnected';
        }

        function updateTradesUI() {
            const tbody = document.getElementById('tradesBody');
            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No trades yet</td></tr>';
                return;
            }

            tbody.innerHTML = trades.slice(0, 15).map(t => `
                <tr>
                    <td>${fmt.time(t.session_datetime)}</td>
                    <td><strong>${t.pair}</strong></td>
                    <td>${t.session_name?.replace('_Open', '')}</td>
                    <td><span class="badge ${t.prediction?.toLowerCase()}">${t.prediction}</span></td>
                    <td>${fmt.price(t.entry_price, t.pair)}</td>
                    <td>${t.tp_pips?.toFixed(1) || '-'} / ${t.sl_pips?.toFixed(1) || '-'}</td>
                    <td>${t.lot_size?.toFixed(2) || '-'}</td>
                    <td>${t.outcome
                        ? `<span class="badge ${t.outcome.toLowerCase()}">${t.outcome}</span>`
                        : '<span class="badge open">OPEN</span>'}</td>
                    <td style="color: ${(t.pnl_dollars || 0) >= 0 ? 'var(--green)' : 'var(--red)'}">
                        ${t.pnl_dollars != null ? ((t.pnl_dollars >= 0 ? '+' : '') + fmt.usd(t.pnl_dollars)) : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function updatePercentilesUI() {
            const tbody = document.getElementById('percentileBody');
            let filtered = percentiles;
            if (selectedSession !== 'all') {
                filtered = percentiles.filter(p => p.session_name === selectedSession);
            }

            if (!filtered || filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No data</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(p => `
                <tr>
                    <td>
                        <span class="pct-pair">${p.pair}</span>
                        <span class="pct-session">${p.session_name?.replace('_Open', '')}</span>
                    </td>
                    <td class="pct-value tp">${p.mfe_p75?.toFixed(1)} pips</td>
                    <td class="pct-value sl">${p.mae_p50?.toFixed(1)} pips</td>
                    <td class="pct-value">${p.accuracy_pct?.toFixed(1)}%</td>
                    <td class="pct-value">${p.sample_count}</td>
                </tr>
            `).join('');
        }

        function togglePercentiles() {
            percentilesOpen = !percentilesOpen;
            document.getElementById('percentileContent').classList.toggle('open', percentilesOpen);
            document.getElementById('toggleText').textContent = percentilesOpen ? 'Hide' : 'Show';
        }

        async function togglePriceStream() {
            const btn = document.getElementById('priceConnectBtn');
            const dot = document.getElementById('priceConnectDot');
            const text = document.getElementById('priceConnectText');
            const content = document.getElementById('priceTickerContent');

            if (priceStreamConnected) {
                // Disconnect
                text.textContent = 'Disconnecting...';
                try {
                    await fetch('/api/prices/disconnect', { method: 'POST' });
                } catch (e) {}
                priceStreamConnected = false;
                if (pricePollingInterval) {
                    clearInterval(pricePollingInterval);
                    pricePollingInterval = null;
                }
                btn.classList.remove('connected');
                dot.classList.remove('active');
                text.textContent = 'Connect';
                content.innerHTML = '<div class="empty-state">Click Connect to stream real-time prices</div>';
                document.getElementById('priceUpdateTime').textContent = '-';
            } else {
                // Connect
                text.textContent = 'Connecting...';
                try {
                    const res = await fetch('/api/prices/connect', { method: 'POST' });
                    const data = await res.json();
                    if (data.status === 'connected' || data.status === 'already_connected') {
                        priceStreamConnected = true;
                        btn.classList.add('connected');
                        dot.classList.add('active');
                        text.textContent = 'Disconnect';
                        content.innerHTML = '<div class="empty-state">Waiting for price data...</div>';
                        // Start polling for prices
                        fetchPrices();
                        pricePollingInterval = setInterval(fetchPrices, 500);
                    } else {
                        text.textContent = 'Connect';
                        content.innerHTML = '<div class="empty-state">Failed to connect: ' + (data.error || 'Unknown error') + '</div>';
                    }
                } catch (e) {
                    text.textContent = 'Connect';
                    content.innerHTML = '<div class="empty-state">Connection error: ' + e.message + '</div>';
                }
            }
        }

        async function fetchPrices() {
            if (!priceStreamConnected) return;
            try {
                const res = await fetch('/api/prices');
                const data = await res.json();
                updatePriceTickerUI(data);
            } catch (e) {
                console.error('Price fetch error:', e);
            }
        }

        function updatePriceTickerUI(data) {
            const content = document.getElementById('priceTickerContent');

            if (!data.connected) {
                priceStreamConnected = false;
                document.getElementById('priceConnectBtn').classList.remove('connected');
                document.getElementById('priceConnectDot').classList.remove('active');
                document.getElementById('priceConnectText').textContent = 'Connect';
                content.innerHTML = '<div class="empty-state">Disconnected</div>';
                if (pricePollingInterval) {
                    clearInterval(pricePollingInterval);
                    pricePollingInterval = null;
                }
                return;
            }

            const prices = data.prices || {};
            const pairs = Object.keys(prices).sort();

            if (pairs.length === 0) {
                content.innerHTML = '<div class="empty-state">Connected - waiting for quotes (markets may be closed)</div>';
                return;
            }

            // Find latest timestamp
            let latestTime = null;
            pairs.forEach(pair => {
                const ts = prices[pair].timestamp;
                if (ts && (!latestTime || new Date(ts) > new Date(latestTime))) {
                    latestTime = ts;
                }
            });
            document.getElementById('priceUpdateTime').textContent = latestTime
                ? 'Updated: ' + new Date(latestTime).toLocaleTimeString()
                : '';

            content.innerHTML = '<div class="price-ticker-grid">' + pairs.map(pair => {
                const p = prices[pair];
                const decimals = (pair.includes('JPY') || pair.includes('XAG')) ? 3 : 5;
                return `
                    <div class="price-ticker-item">
                        <div class="price-ticker-pair">${pair}</div>
                        <div class="price-ticker-mid">${p.mid?.toFixed(decimals) || '-'}</div>
                        <div class="price-ticker-spread">
                            <span class="price-ticker-bid">Bid: ${p.bid?.toFixed(decimals) || '-'}</span>
                            <span class="price-ticker-ask">Ask: ${p.ask?.toFixed(decimals) || '-'}</span>
                        </div>
                        <div class="price-ticker-spread">
                            <span>Spread: ${p.spread_pips?.toFixed(1) || '-'} pips</span>
                        </div>
                    </div>
                `;
            }).join('') + '</div>';
        }

        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                selectedSession = tab.dataset.session;
                updatePercentilesUI();
            });
        });

        async function fetchData() {
            try {
                const [accRes, schRes, tradesRes, pctRes] = await Promise.all([
                    fetch('/api/account'),
                    fetch('/api/scheduler/status'),
                    fetch('/api/trades?limit=15'),
                    fetch('/api/percentiles')
                ]);

                account = await accRes.json();
                scheduler = await schRes.json();
                trades = await tradesRes.json();
                percentiles = await pctRes.json();

                updateAccountUI();
                updateSchedulerUI();
                updateTradesUI();
                updatePercentilesUI();

                document.getElementById('statusDot').className = 'status-dot';
                document.getElementById('statusText').textContent = 'Live';
            } catch (err) {
                console.error('Fetch error:', err);
                document.getElementById('statusDot').className = 'status-dot offline';
                document.getElementById('statusText').textContent = 'Offline';
            }
        }

        // WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'account') {
                    account = data.data;
                    updateAccountUI();
                } else if (data.type === 'scheduler') {
                    scheduler = data.data;
                    updateSchedulerUI();
                } else if (data.type === 'trade') {
                    trades.unshift(data.data);
                    trades = trades.slice(0, 15);
                    updateTradesUI();
                }
            };

            ws.onclose = () => setTimeout(connectWebSocket, 3000);
        }

        fetchData();
        connectWebSocket();
        setInterval(updateCountdown, 1000);
        setInterval(fetchData, 10000);
    </script>
</body>
</html>
